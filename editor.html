<html>
<!-- -------Yahoo! CSS Javascript--------------------------------------------------- -->

<!-- Combo-handled YUI CSS files: -->
<link rel="stylesheet" type="text/css"
	href="http://yui.yahooapis.com/combo?2.9.0/build/assets/skins/sam/skin.css">
<!-- Combo-handled YUI JS files: -->
<script type="text/javascript"
	src="http://yui.yahooapis.com/combo?2.9.0/build/yahoo-dom-event/yahoo-dom-event.js&2.9.0/build/element/element-min.js&2.9.0/build/connection/connection-min.js&2.9.0/build/dragdrop/dragdrop-min.js&2.9.0/build/container/container-min.js&2.9.0/build/menu/menu-min.js&2.9.0/build/button/button-min.js&2.9.0/build/editor/editor-min.js"></script>

<!-- -------------------------------------------------------------------------------------------------- -->

<script src="/socket.io/socket.io.js"></script>
<script src="/lib/user.js"></script>
<script src="/lib/ckeditor/ckeditor.js"></script>
<script src="/lib/html.js"></script>
<script src="http://code.jquery.com/jquery-latest.min.js"></script>
<script src="http://code.jquery.com/ui/1.10.2/jquery-ui.js"></script>
<link rel="stylesheet"
	href="http://code.jquery.com/ui/1.10.2/themes/smoothness/jquery-ui.css" />
<link rel="stylesheet" type="text/css" href="home.css">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.6" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
</head>
<script>

	var socket = io.connect("http://" + window.location.host + "/");
	var gameid = "";
	var mobile_url = "";
	var monitor_url = "";
	var editor_content = "";
	


	function initiate() {
		var param = window.location.search.replace("?", "");
		param = param.split("=");
		gameid = param[1];
		mobile_url = "http://" + window.location.host + "/Games/" + gameid
				+ "/index.html";
		monitor_url = "http://" + window.location.host + "/Games/" + gameid
				+ "/monitor.html";

		if (gameid != null) {
			$('#mobile').attr("src", mobile_url);
			$('#monitor').attr("src", monitor_url);
		}
	}

	function save() {
		var html_start = "<html>";
		var html_close = "</html>";
		var html_mobile = $("#mobile").contents().find("html").html();
		var html_monitor = $("#monitor").contents().find("html").html();
		var path_mobile = './Games/' + gameid + '/index.html';
		var path_monitor = './Games/' + gameid + '/monitor.html';
		
		socket.emit("save", path_mobile, html_start+html_mobile+html_close);
		socket.emit("save", path_monitor, html_start+html_monitor+html_close);
	}

	function add(element) {
		var html = new Html();
		var latestbuttonID = $("#mobile").contents().find(".buttons").last().attr('id');
		if (latestbuttonID !== undefined){
		var latestbuttonNumber = latestbuttonID.split("_");
		var buttonid  = parseInt(latestbuttonNumber[1]) + 1;
		}
		else{
         var buttonid = 1;
		}
		var name = "button_" + buttonid;
		var button = html.addButton(name, 'youtube',
				'https://www.youtube.com/watch?v=f_SnZubaArM');
		$('#mobile').contents().find('body').append(button);
		save();
		setTimeout('reload("mobile")', 100);
	}

	function reload(iframeid) {
		var iframe = document.getElementById(iframeid);
		iframe.src = iframe.src;
	}
	
	function addMonitorText(id,editorContent){
		var html = new Html();
		var content = html.addDiv(id,editorContent);
		$('#monitor').contents().find("#"+id).remove();
		$('#monitor').contents().find('body').append(content);
		save();
	}
	
	function getButtonProperties(id){
		var name = $("#mobile").contents().find("#"+id).text();
		name = $.trim(name);
		var onclick = $("#mobile").contents().find("#"+id).attr('onclick');
		var split_onclick = onclick.split("\'");
		var type = split_onclick[1];
		var content = split_onclick[3];
		var properties = [name,type,content];
		
		var url_content = $("#url").html();
		var text_content = $("#textarea").html();

		return properties;
	}
	
	function insertIntoEditor(id){
		var html = $('#monitor').contents().find("#" + id).html();
		var editor_html = '&lt;p&gt;'+html+'&lt;/p&gt;';
		console.log(html);
		$('#msgpost').html(editor_html);
	}

	function edit() {
		var selected = $("select option:selected").val();
		var id = $("#id").val();
		var title = $("#name").val();
		var mobile_title = '<span class="ui-btn-inner">'+'\n'
						  +'<span class="ui-btn-text">'+title+'</span>'+'\n'
						  +'</span>';		
		var editor1 = CKEDITOR.instances['msgpost'];
		var editorContent = editor1.getData();

		if (selected == "youtube") {
			var content = $("#url_value").val();
			$('#mobile').contents().find("#" + id).attr("onclick",
					"emitter('youtube','" + content + "')");
		} else {
			var content = "#" + id;

			alert(editorContent);
			addMonitorText(id, editorContent);
			$('#mobile').contents().find("#" + id).attr("onclick",
					"emitter('text','" + content + "')");
		}
		$('#mobile').contents().find("#" + id).html(mobile_title);
		save();
	}

	$(document).ready(
			function() {
				$("#mobile").load(
						function() {
							$("#mobile").contents().find(".buttons").bind(
									"contextmenu", function(e) {
										e.preventDefault();
										var name = $("#mobile").contents().find("#"+this.id).text();
										var properties = getButtonProperties(this.id);
										$("#id").val(this.id);
										$("#name").val(properties[0]);
										var editor = CKEDITOR.instances['msgpost'];
									    if (editor) { editor.destroy(true); }
									    CKEDITOR.replace( 'msgpost', {
										    toolbar: 'Basic',
										    uiColor: '#9AB8F3'
										});
										if(properties[1] == "youtube"){
											var editor = CKEDITOR.instances['msgpost'];
											if (editor) { editor.destroy(true); }
											$("#msgpost").hide();
											$("#url").show();
											$("#url_value").val(properties[2]);
										}
										else{
											insertIntoEditor(this.id);
											$("#url").hide();
										}
										$("select").val(properties[1]);
										$( "#dialog" ).dialog({ width: 750});
									});
							$("#mobile").contents().find(".buttondel").bind(
									"click", function(e) {
										$(this).parent().prev().remove();
										$(this).parent().remove();
										save();
									});
						});
				$("select").change(function() {
					
					var url_content = $("#url").html();
					var text_content = $("#textarea").html();
					var value = $("select option:selected").val();
					if (value == "youtube") {
						$("#url").show();
						var editor = CKEDITOR.instances['msgpost'];
					    if (editor) { $("#cke_msgpost").hide(); }
					} else {
						var editor = CKEDITOR.instances['msgpost'];
					    if (editor) { $("#cke_msgpost").show(); }
					    else{
					    CKEDITOR.replace( 'msgpost', {
						    toolbar: 'Basic',
						    uiColor: '#9AB8F3'
						});
					    }
						$("#url").hide();
						
					}
				}).trigger('change');
				
				$("#showing").bind(
						"click", function(e) {
							var editor1 = CKEDITOR.instances['msgpost'];
							console.log(editor1.getData());
						});
			});
</script>
<body class="yui-skin-sam" onload="initiate()">
	<div id="wrap">
		<div id="add">
			<img onclick="add('button')"
				src="/img/button.png" /> <img
				onclick="edit('Test','Hallo','#')"
				src="/img/image.png" /> <img
				src="/img/text.png" /> <img
				src="/img/vimeo.png" /> <img
				src="/img/youtube.png" />
		</div>
		<iframe id="mobile" src=""></iframe>
		<iframe id="monitor" src=""></iframe>
	</div>
	<div id="dialog" style="display: none">
			<p style="display: none">
				<input type="text" id="id" name="id" value=""><br>
			</p>
			Name: <input type="text" id="name" class="nice-input" name="name" value=""><br> <br>
			Type: <select class="nice-input">
				<option value="text" selected="selected">Text</option>
				<option value="youtube">Youtube</option>
			</select> <br> <br>
			<h5>Content:</h5> 
			
			<div id="url" style="display:none">
			Url: <input id="url_value" class="nice-input-url" name="url">
			</div><br>
			<textarea name="msgpost" id="msgpost" cols="50" rows="10"></textarea><br><br>
			<button onclick="edit()">Save</button>
			<button id="showing">Editor</button>
	</div>
</body>
</html>